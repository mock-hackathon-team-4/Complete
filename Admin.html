<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Admin Page</title>

    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase.js"></script>
    <script>
      var firebaseConfig = {
        apiKey: 'AIzaSyBrePrVL7CuPjjnbe8xNGmeg0I8UHP1izs',
        authDomain: 'first-web-e0fb1.firebaseapp.com',
        databaseURL: 'https://first-web-e0fb1.firebaseio.com',
        projectId: 'first-web-e0fb1',
        storageBucket: 'first-web-e0fb1.appspot.com',
        messagingSenderId: '879234316989',
        appId: '1:879234316989:web:f1e6215e2c8c7cbd4115d4',
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
    </script>
    <style>
      .container {
        margin-top: 50px;

        margin-bottom: 50px;
      }
      .header {
        padding: 30px;
        background-color: cadetblue;
        text-align: center;
        border-radius: 10px;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>NGO Admin Page</h1>
      </div>
    </div>

    <!-- modal-->
    <!--<button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#edithero">
        Edit 
    </button>-->
    <div class="modal" id="edithero" tabindex="-1" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Hero</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <input type="hidden" class="form-control" id="heroid" />

              <div class="form-group">
                <label for="editinputeventname">Event Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="editinputeventname"
                  aria-describedby="emailHelp"
                  placeholder="Event name"
                  required="true"
                />
              </div>

              <div class="form-group">
                <label for="editinputeventlocation">Event Location</label>
                <input
                  type="text"
                  class="form-control"
                  id="editinputeventlocation"
                  aria-describedby="emailHelp"
                  placeholder="Event Location"
                  required="true"
                />
              </div>

              <div class="form-group">
                <label for="editinputeventcontact">Contact Number</label>
                <input
                  type="text"
                  class="form-control"
                  id="editinputeventcontact"
                  aria-describedby="emailHelp"
                  placeholder="Ph"
                  required="true"
                />
              </div>

              <div class="form-group">
                <label for="editinputeventdesc">Description:</label>
                <textarea
                  class="form-control"
                  rows="5"
                  id="editinputeventdesc"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button id="edit-hero-button" type="button" class="btn btn-primary">
              Update changes
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- login-->
    <div class="container">
      <a href="#add-hero">
        <button id="scrollbutton" type="button" class="btn btn-primary">
          Create
        </button>
      </a>
      <button
        style="
          font-size: 24px;
          float: right;
          border-radius: 50%;
          border-color: black;
        "
      >
        <i class="fas fa-user"></i>
      </button>
      <br />
      <p style="float: right;" id="usericon"></p>
      <br />
      <div class="container" id="logout">
        <button
          id="logout-button"
          style="width: 100px; float: right;"
          type="button"
          class="btn btn-danger btn-block"
        >
          Log Out
        </button>
      </div>
    </div>
    <div class="container" id="login-form">
      <h1>Log In Or Create Account</h1>

      <div class="jumbotron">
        <form>
          <div class="form-group">
            <label for="inputemail">Email </label>
            <input
              type="email"
              class="form-control"
              id="inputemail"
              aria-describedby="emailHelp"
              placeholder="Enter email"
            />
          </div>
          <div class="form-group">
            <label for="inputpasswd">Password</label>
            <input
              type="password"
              class="form-control"
              id="inputpasswd"
              placeholder="Password"
            />
          </div>

          <button
            id="sign-in-button"
            type="button"
            class="btn btn-primary btn-block"
          >
            Sign In
          </button>
          <button
            id="create-user-button"
            type="button"
            class="btn btn-warning btn-block"
          >
            Create Account
          </button>
          <button
            id="google-login-button"
            type="button"
            class="btn btn-primary btn-block"
          >
            Sign In with Google
          </button>
        </form>
      </div>
    </div>

    <div class="container" id="views"></div>
    <div class="container" id="show-hero">
      <h1>Show heroes</h1>
    </div>

    <div class="container" id="add-hero">
      <h1>Create Event</h1>
      <div class="jumbotron">
        <form>
          <div class="form-group">
            <label for="inputeventname">Event Name</label>
            <input
              type="text"
              class="form-control"
              id="inputeventname"
              aria-describedby="emailHelp"
              placeholder="Event name"
              required="true"
            />
          </div>

          <div class="form-group">
            <label for="inputeventlocation">Event Location</label>
            <input
              type="text"
              class="form-control"
              id="inputeventlocation"
              aria-describedby="emailHelp"
              placeholder="Event Location"
              required="true"
            />
          </div>

          <div class="form-group">
            <label for="inputeventcontact">Contact Number</label>
            <input
              type="text"
              class="form-control"
              id="inputeventcontact"
              aria-describedby="emailHelp"
              placeholder="Ph"
              required="true"
            />
          </div>

          <div class="form-group">
            <label for="inputeventdesc">Description:</label>
            <textarea
              class="form-control"
              rows="5"
              id="inputeventdesc"
            ></textarea>
          </div>
        </form>
        <button
          id="create-newhero-button"
          type="button"
          class="btn btn-primary btn-block"
        >
          Create
        </button>
      </div>
    </div>
    <script>
      var currentuser = {};
      $('#create-user-button').click(function () {
        var email = $('#inputemail').val();
        var password = $('#inputpasswd').val();
        console.log('user= ' + email + ' ' + password);
        CreateUser(email, password);
      });
      $('#sign-in-button').click(function () {
        var email = $('#inputemail').val();
        var password = $('#inputpasswd').val();
        console.log('existinguser= ' + email + ' ' + password);
        SignIn(email, password);
        $('#usericon').text(email);
        $('#scrollbutton').show();
        $('#show-hero').show();
        $('#logout-button').show();
        $('#logout').show();
        $('#views').show();
      });
      $('#logout-button').click(function () {
        firebase.auth().signOut();
        console.log('loged out');
        $('#usericon').text(' ');
        $('#login-form').show();
        $('#add-hero').hide();
        $('#show-hero').hide();
        $('#views').hide();
        $('#logout').hide();
        $('#scrollbutton').hide();
      });
      function CreateUser(email, password) {
        firebase
          .auth()
          .createUserWithEmailAndPassword(email, password)
          .catch(function (error) {
            // Handle Errors here.
            var errorCode = error.code;
            var errorMessage = error.message;
            // ...
          });
      }
      function writeUserData(user) {
        firebase
          .database()
          .ref('users/' + user.uid)
          .set({
            email: user.email,
          });
      }
      function SignIn(email, password) {
        firebase
          .auth()
          .signInWithEmailAndPassword(email, password)
          .catch(function (error) {
            // Handle Errors here.
            var errorCode = error.code;
            var errorMessage = error.message;
            // ...
          });
      }
      $('#google-login-button').click(function () {
        var provider = new firebase.auth.GoogleAuthProvider();
        firebase
          .auth()
          .signInWithPopup(provider)
          .then(function (result) {
            // This gives you a Google Access Token. You can use it to access the Google API.
            var token = result.credential.accessToken;
            // The signed-in user info.
            currentuser = result.user;
            $('#usericon').text(currentuser);
            // ...
          })
          .catch(function (error) {
            // Handle Errors here.

            var errorMessage = error.message;
            alert(errorMessage);
            // The email of the user's account used.
            var email = error.email;
            // The firebase.auth.AuthCredential type that was used.
            var credential = error.credential;
            // ...
          });
      });

      var heroref = firebase.database().ref().child('heroes');
      heroref.on('value', function (snapshot) {
        $('#show-hero').empty();
        var heroHtml = "<h1 style='color:blue;'>Events</h1>";
        snapshot.forEach(function (childsnapshot) {
          var person = childsnapshot.val();

          heroHtml += "<div class='jumbotron'><div class 'heroHtml'<hr>";
          heroHtml +=
            "<p style='font-size:30px;font-weight:500;margin-left:25px'>Event Name : <span class='hero-data-name'>" +
            person.name +
            '</span> </li>';
          heroHtml +=
            "<li style='margin-left:35px;font-size:20px;'>Location : <span class='hero-data-location'>" +
            person.location +
            '</span> </li>';
          heroHtml +=
            "<li style='margin-left:35px; font-size:20px;'>Contact : <span class='hero-data-contact'>" +
            person.contact +
            '</span> </li>';
          heroHtml +=
            "<li style='margin-left:35px; font-size:20px;'>Description : <span class='hero-data-desc'>" +
            person.description +
            '</span> </li>';

          heroHtml += '</ul><br>';
          heroHtml +=
            " <button type='button' class='btn btn-danger delete-hero' id=" +
            person.id +
            '>Delete</button>';
          heroHtml +=
            " <button type='button' class='btn btn-primary edit-hero-button' data-heroid='" +
            person.id +
            "' data-toggle='modal' data-target='#edithero'>Edit</button>";
          heroHtml +=
            " <button type='button' class='btn btn-success view-hero' id=" +
            person.name +
            '>View Applications</button>';
          heroHtml += '</div></div>';
        });
        $('#show-hero').html(heroHtml);
      });
      var ev = ' ';
      $(document).on('click', '.view-hero', function () {
        var heroid = $(this).attr('id');
        ev = heroid;

        var viewref = firebase.database().ref('events/' + heroid);
        viewref.on('value', function (snapshot) {
          $('#views').empty();
          viewHtml = '<h3>' + heroid + ' Requests</h3>';

          snapshot.forEach(function (childsnapshot) {
            var w = childsnapshot.val();
            console.log(w);
            viewHtml += w;
            viewHtml +=
              "<button type='button' style='margin:10px' class='btn btn-success accept-hero' id='accept" +
              w +
              "'>Accept</button>";
            viewHtml +=
              "<button type='button' style='margin:10px' class='btn btn-danger reject-hero' id=reject" +
              w +
              "'>Reject</button>";
            viewHtml += '<br>';
          });
          $('#views').html(viewHtml);
        });
      });
      $(document).on('click', '.accept-hero', function () {
        var volunterid = $(this).attr('id');
        console.log(volunterid);
        $(this).text('Accepted');
        var $rate = $(
          "<form><input id='slider' type='range' name='amountRange' min='0' max='10' value='0' oninput='this.form.amountInput.value=this.value'/><input type='number' name='amountInput' min='0' max='10' value='0' oninput='this.form.amountRange.value=this.value' /></form><button class='btn btn-info ratebtn'>Submit</button>"
        );

        $(this).after($rate);
        $('#volunterid').hide();
      });

      $(document).on('click', '.ratebtn', function () {
        var ratings = $('#slider').val();

        submitrating(ratings);
      });

      $(document).on('click', '.reject-hero', function () {
        var volunterid = $(this).attr('id');
        $('#volunterid').hide();
        $(this).text('Rejected');
      });
      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          // User is signed in.

          var email = user.email;
          currentuser = user;
          writeUserData(user);

          $('#login-form').hide();
          $('#add-hero').show();
        } else {
          // User is signed out.
          // ...
        }
      });
      $('#create-newhero-button').click(function () {
        var hero = {
          id: $('#inputeventname').val() + Date.now(),
          Owner: currentuser.uid,
          name: $('#inputeventname').val(),
          location: $('#inputeventlocation').val(),
          contact: $('#inputeventcontact').val(),
          description: $('#inputeventdesc').val(),
        };
        addherodata(hero);
      });

      $('#edit-hero-button').click(function () {
        var hero = {
          id: $('#heroid').val(),
          name: $('#editinputeventname').val(),
          location: $('#editinputeventlocation').val(),
          contact: $('#editinputeventcontact').val(),
          description: $('#editinputeventdesc').val(),
        };
        console.log(hero);
        console.log('updated');
        addherodata(hero);
      });
      $(document).on('click', '.delete-hero', function () {
        var heroid = $(this).attr('id');
        firebase
          .database()
          .ref('heroes/' + heroid)
          .remove();
        firebase
          .database()
          .ref('users/' + currentuser.uid + 'heroes/' + heroid)
          .remove();
      });

      $(document).on('click', '.edit-hero-button', function () {
        var heroid = $(this).attr('data-heroid');
        console.log('click' + heroid);
        $('#heroid').val(heroid);

        var eventname = $(this).parent().find('.hero-data-name').text();
        $('#editinputeventname').val(eventname);

        var eventlocation = $(this).parent().find('.hero-data-location').text();
        $('#editinputeventlocation').val(eventlocation);

        var eventcontact = $(this).parent().find('.hero-data-contact').text();
        $('#editinputeventcontact').val(eventcontact);

        var eventdesc = $(this).parent().find('.hero-data-desc').text();
        $('#editinputeventdesc').val(eventdesc);
      });

      $('.hero-sss').on('change', function () {
        var currentvalue = $(this).val();
        $(this).parent().find('span').text(currentvalue);
      });

      function addherodata(h) {
        var database = firebase.database();

        firebase
          .database()
          .ref('events/' + h.name)
          .set(' ');
        firebase
          .database()
          .ref('heroes/' + h.id)
          .set(h);
        firebase
          .database()
          .ref('users/' + currentuser.uid + '/heroes/' + h.id)
          .set(h);
      }
      function submitrating(r) {
        var database = firebase.database();

        var viewref = firebase.database().ref('events/' + ev);
        viewref.on('value', function (snapshot) {
          viewHtml = '<h3>' + heroid + ' Requests</h3>';

          snapshot.forEach(function (childsnapshot) {
            var w = childsnapshot.val();
            if (w == currentuser.email) {
              var s = {
                rating: r,
              };
              firebase
                .database()
                .ref('events/' + ev + vol + '/rating/')
                .set(s);
            }
          });
        });
      }
    </script>
  </body>
</html>
